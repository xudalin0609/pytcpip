# 链路层

## 链路层提供的主要服务
- 成帧
- 链路接入
- 可靠交付
- 差错检验和纠正


## 链路层的位置

链路层的主体部分为网络适配器（network adpater）,也称为NIC,实现了许多链路层服务（成帧,链路接入,可靠交付）, 但仍有部分功能由链路层的软件组实现（如差错控制、激活控制）, **因此链路层是软件和硬件交接的地方**

由于使用无法直接操作网络适配器, 这里使用TAP/TUN模拟实现链路层功能

> TAP/TUN 设备是一种让用户态和内核之间进行数据交换的虚拟设备，TAP 工作在二层，TUN 工作在三层，TAP/TUN 网卡的两头分别是内核网络协议栈和用户层,其作用是将协议栈中的部分数据包转发给用户空间的应用程序，给用户空间的程序一个处理数据包的机会。当我们想在 linux 中创建一个 TAP 设备时，其实很容易，像普通文件一样打开字符设备/dev/net/tun可以得到一个文件描述符，接着用系统调用 ioctl 将文件描述符和 kernel 的 tap 驱动绑定在一起，那么之后对该文件描述符的读写就是对虚拟网卡 TAP 的读写。

```
+----------------------+
|  userland netstack   |
+----------------------+
|         tap          |
+----------------------+
|       kernel         |
+----------------------+
```




#### 测试1
```
python .\lab\link\tap1.py
```
启动了一个tap网卡，并持续的从tap读取数据

```
sudo tcpdump -i tap0 -n
```
利用tcpdump抓取经过tap0网卡的数据

```
ping 192.168.1.2
```
可以看到,ping封装了一个icmp报文,到链路层后由于找不到192.168.1.2对应的MAC地址,tap0发送了ARP请求,tcpdump抓取到在tap0网卡的ARP请求.